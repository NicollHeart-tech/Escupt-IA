<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>Escupt IA</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --bg-main: #2a004f; --bg-sidebar: #4b0082; --bg-input: #3d0070;
            --text-color: #ffffff; --msg-user: #6d28d9; --msg-ai: rgba(255, 255, 255, 0.1);
        }
        [data-theme="claro"] {
            --bg-main: #ffffff; --bg-sidebar: #b3b3b3; --bg-input: #e0e0e0;
            --text-color: #000000; --msg-user: #808080; --msg-ai: #f0f0f0;
        }
        [data-theme="escuro"] {
            --bg-main: #000000; --bg-sidebar: #1a1a1a; --bg-input: #262626;
            --text-color: #ffffff; --msg-user: #333333; --msg-ai: #1a1a1a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg-main); color: var(--text-color); height: 100vh; overflow: hidden; display: flex; }

        /* TELA DE LOGIN */
        #login-screen {
            position: fixed; inset: 0; background: var(--bg-main);
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999;
        }
        .login-card { background: var(--bg-input); padding: 40px; border-radius: 25px; text-align: center; width: 90%; max-width: 350px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .google-btn {
            background: white; color: #444; border: none; padding: 12px; border-radius: 10px; 
            font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px; width: 100%; justify-content: center; margin-top: 20px;
        }

        /* APP CONTAINER */
        #app-container { display: none; width: 100%; height: 100%; flex-direction: row; }
        #sidebar { width: 260px; background: var(--bg-sidebar); padding: 20px; display: flex; flex-direction: column; transition: 0.3s; }
        
        #main-content { flex: 1; display: flex; flex-direction: column; position: relative; background: var(--bg-main); }

        /* BOTÃO CONFIGS */
        .settings-btn { position: fixed; top: 15px; right: 15px; cursor: pointer; z-index: 2000; width: 35px; }
        #theme-menu { position: fixed; top: 60px; right: 15px; background: var(--bg-input); padding: 10px; border-radius: 15px; display: none; flex-direction: column; gap: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .t-btn { border: none; padding: 10px; border-radius: 8px; cursor: pointer; color: white; text-align: left; }

        /* CHAT */
        #chatWindow { flex: 1; overflow-y: auto; padding: 80px 20px 150px; display: flex; flex-direction: column; gap: 15px; }
        .message { max-width: 80%; padding: 12px 18px; border-radius: 20px; line-height: 1.4; font-size: 0.95rem; }
        .user-message { align-self: flex-end; background: var(--msg-user); color: white; border-bottom-right-radius: 4px; }
        .ai-message { align-self: flex-start; background: var(--msg-ai); border-bottom-left-radius: 4px; }

        .footer-area { position: absolute; bottom: 0; width: 100%; padding: 20px; background: var(--bg-main); display: flex; justify-content: center; }
        .input-wrapper { width: 100%; max-width: 800px; background: var(--bg-input); border-radius: 30px; padding: 5px 20px; display: flex; align-items: center; }
        .input-box { flex: 1; padding: 12px; background: transparent; border: none; color: white; outline: none; font-size: 16px; }
    </style>
</head>
<body data-theme="roxo">

    <div id="login-screen">
        <div class="login-card">
            <img src="logoroxa.png" width="80" id="loginLogo">
            <h2 style="margin-top:15px">Escupt IA</h2>
            <button class="google-btn" onclick="loginComGoogle()">
                <img src="https://fonts.gstatic.com/s/i/productlogos/googleg/v6/24px.svg" width="20">
                Entrar com Google
            </button>
        </div>
    </div>

    <div id="app-container">
        <aside id="sidebar">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                <img id="userPhoto" src="" style="width:35px; border-radius:50%; display:none">
                <span id="userName" style="font-weight: bold; font-size: 0.9rem;">Usuário</span>
            </div>
            <button onclick="location.reload()" style="padding:10px; background:rgba(255,255,255,0.1); border:none; color:white; border-radius:10px; cursor:pointer">Novo Chat +</button>
            <button onclick="logout()" style="margin-top: auto; padding: 10px; background: none; border: 1px solid #ff4444; color: #ff4444; border-radius: 10px; cursor: pointer;">Sair</button>
        </aside>

        <main id="main-content">
            <div class="settings-btn" onclick="toggleThemeMenu()">
                <img src="Configroxa.png" id="configIcon">
            </div>

            <div id="theme-menu">
                <button class="t-btn" style="background:#6d28d9" onclick="setTheme('roxo')">Roxo</button>
                <button class="t-btn" style="background:#888" onclick="setTheme('claro')">Claro</button>
                <button class="t-btn" style="background:#1a1a1a" onclick="setTheme('escuro')">Preto</button>
            </div>

            <div id="chatWindow">
                <div id="welcome" style="text-align:center; margin-top:20vh">
                    <img src="logoroxa.png" width="100" id="mainLogo">
                    <h2 id="welcomeText">Como posso ajudar?</h2>
                </div>
            </div>

            <div class="footer-area">
                <div class="input-wrapper">
                    <input type="text" class="input-box" id="userInput" placeholder="Escreva uma mensagem...">
                </div>
            </div>
        </main>
    </div>

    <script>
        // CONFIGURAÇÕES FIREBASE (Suas chaves enviadas)
        const firebaseConfig = {
            apiKey: "AIzaSyBnaeFZVMY7M2bG177YKB5yKqdH58YdBJo",
            authDomain: "escupt-ia.firebaseapp.com",
            projectId: "escupt-ia",
            storageBucket: "escupt-ia.firebasestorage.app",
            messagingSenderId: "972278178048",
            appId: "1:972278178048:web:f1bc58e002a977eca453e5",
            measurementId: "G-BKZ90P6R0Z"
        };

        firebase.initializeApp(firebaseConfig);

        // LOGIN / LOGOUT
        function loginComGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            firebase.auth().signInWithPopup(provider).catch(e => alert("Erro ao logar: " + e.message));
        }

        function logout() { firebase.auth().signOut().then(() => location.reload()); }

        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                document.getElementById('login-screen').style.display = "none";
                document.getElementById('app-container').style.display = "flex";
                document.getElementById('userName').textContent = user.displayName;
                document.getElementById('userPhoto').src = user.photoURL;
                document.getElementById('userPhoto').style.display = "block";
                document.getElementById('welcomeText').textContent = `Olá, ${user.displayName.split(' ')[0]}!`;
            }
        });

        // LÓGICA DO CHAT E EFEITO DE ESCRITA
        const NGROK_URL = "https://chorographically-nonallegiance-rubye.ngrok-free.dev";
        const MODEL_NAME = "EscuptIA_Oficial";

        async function sendMessage(text) {
            document.getElementById('welcome').style.display = "none";
            addMsgToUI(text, 'user-message');

            const aiDiv = addMsgToUI("", 'ai-message');
            aiDiv.innerHTML = "<i>Digitando...</i>";

            try {
                const response = await fetch(`${NGROK_URL}/api/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: MODEL_NAME, prompt: text, stream: false })
                });
                const data = await response.json();
                typeWrite(aiDiv, data.response);
            } catch (err) {
                aiDiv.textContent = "Erro ao conectar com a IA.";
            }
        }

        function typeWrite(element, text) {
            let i = 0;
            element.innerHTML = "";
            function type() {
                if (i < text.length) {
                    element.innerHTML = marked.parse(text.substring(0, i + 1));
                    i++;
                    const cw = document.getElementById('chatWindow');
                    cw.scrollTop = cw.scrollHeight;
                    setTimeout(type, 15);
                }
            }
            type();
        }

        function addMsgToUI(text, cls) {
            const d = document.createElement('div');
            d.className = `message ${cls}`;
            if(text) d.innerHTML = marked.parse(text);
            const cw = document.getElementById('chatWindow');
            cw.appendChild(d);
            cw.scrollTop = cw.scrollHeight;
            return d;
        }

        document.getElementById('userInput').addEventListener('keypress', e => {
            if(e.key === 'Enter' && e.target.value.trim()) {
                sendMessage(e.target.value);
                e.target.value = "";
            }
        });

        // TEMAS E INTERFACE
        function setTheme(t) {
            document.body.setAttribute('data-theme', t);
            const logo = document.getElementById('mainLogo');
            const loginLogo = document.getElementById('loginLogo');
            const icon = document.getElementById('configIcon');
            
            if(t === 'roxo') { 
                logo.src = loginLogo.src = "logoroxa.png"; 
                icon.src = "Configroxa.png"; 
            } else if(t === 'claro') { 
                logo.src = loginLogo.src = "logobranca.png"; 
                icon.src = "Configbranca.png"; 
            } else { 
                logo.src = loginLogo.src = "logoescura.png"; 
                icon.src = "Configescura.png"; 
            }
            document.getElementById('theme-menu').style.display = "none";
        }

        function toggleThemeMenu() {
            const m = document.getElementById('theme-menu');
            m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
        }
    </script>
</body>
</html>
