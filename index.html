<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>Escupt IA</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --bg-main: #2a004f; --bg-sidebar: #4b0082; --bg-input: #3d0070; --text-color: #ffffff; --msg-user: #6d28d9; --msg-ai: rgba(255, 255, 255, 0.1); }
        [data-theme="claro"] { --bg-main: #ffffff; --bg-sidebar: #b3b3b3; --bg-input: #e0e0e0; --text-color: #000000; --msg-user: #808080; --msg-ai: #f0f0f0; }
        [data-theme="escuro"] { --bg-main: #000000; --bg-sidebar: #1a1a1a; --bg-input: #262626; --text-color: #ffffff; --msg-user: #333333; --msg-ai: #1a1a1a; }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-main); color: var(--text-color); height: 100vh; overflow: hidden; display: flex; }
        
        /* LOGIN */
        #login-screen { position: fixed; inset: 0; background: var(--bg-main); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; }
        .login-card { background: var(--bg-input); padding: 40px; border-radius: 25px; text-align: center; width: 90%; max-width: 350px; }
        .google-btn { background: white; color: #444; border: none; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px; width: 100%; justify-content: center; margin-top: 20px; }
        
        /* CONTAINER */
        #app-container { display: none; width: 100%; height: 100%; position: relative; }
        
        /* SIDEBAR */
        #sidebar { width: 260px; background-color: var(--bg-sidebar); display: flex; flex-direction: column; padding: 20px; position: fixed; left: -260px; height: 100%; transition: 0.3s; z-index: 9000; }
        #sidebar.active { left: 0; }
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; z-index: 8500; }
        
        /* BOTÕES TOPO */
        .menu-toggle { position: fixed; top: 15px; left: 15px; font-size: 24px; cursor: pointer; z-index: 8000; color: var(--text-color); }
        
        /* ÍCONE DE CONFIGURAÇÕES AJUSTADO */
        .settings-btn { 
            position: fixed; 
            top: 10px; 
            right: 10px; 
            width: 44px; /* Área de clique confortável */
            height: 44px; 
            cursor: pointer; 
            z-index: 8000; 
            display: flex; 
            align-items: center; 
            justify-content: center;
        }
        .settings-btn img { 
            width: 24px; /* TAMANHO REAL DO ÍCONE */
            height: 24px; 
            object-fit: contain; 
        }
        
        #theme-menu { position: fixed; top: 60px; right: 15px; background: var(--bg-input); padding: 10px; border-radius: 15px; display: none; flex-direction: column; gap: 8px; z-index: 9500; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
        .t-btn { border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; color: white; font-weight: bold; text-align: left; }
        
        /* CHAT */
        #chatWindow { flex: 1; overflow-y: auto; padding: 80px 15px 150px; display: flex; flex-direction: column; gap: 15px; }
        .message { max-width: 85%; padding: 12px 16px; border-radius: 20px; font-size: 0.95rem; word-wrap: break-word; }
        .user-message { align-self: flex-end; background: var(--msg-user); color: white; border-bottom-right-radius: 4px; }
        .ai-message { align-self: flex-start; background: var(--msg-ai); border-bottom-left-radius: 4px; }
        
        .footer-area { position: absolute; bottom: 0; width: 100%; padding: 15px; background: var(--bg-main); display: flex; justify-content: center; }
        .input-wrapper { width: 100%; max-width: 800px; background: var(--bg-input); border-radius: 30px; padding: 5px 15px; display: flex; align-items: center; }
        .input-box { flex: 1; padding: 12px; background: transparent; border: none; color: var(--text-color); outline: none; font-size: 16px; }
        @media (min-width: 1024px) { #sidebar { position: relative; left: 0; } .menu-toggle { display: none; } #app-container { display: flex; } }
    </style>
</head>
<body data-theme="roxo">

    <div id="login-screen">
        <div class="login-card">
            <img src="logoroxa.png" width="80" id="loginLogo">
            <h2 style="margin-top:15px">Escupt IA</h2>
            <button class="google-btn" id="btn-login-google">
                <img src="https://fonts.gstatic.com/s/i/productlogos/googleg/v6/24px.svg" width="20">
                Entrar com Google
            </button>
        </div>
    </div>

    <div id="app-container">
        <div id="overlay" onclick="toggleSidebar()"></div>
        <div class="menu-toggle" onclick="toggleSidebar()">☰</div>

        <aside id="sidebar">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 25px;">
                <img id="userPhoto" src="" style="width:35px; border-radius:50%; display:none">
                <span id="userName" style="font-weight: bold; font-size: 0.85rem;">Usuário</span>
            </div>
            <button onclick="clearChat()" style="padding:12px; background:rgba(255,255,255,0.1); border:none; color:white; border-radius:10px; cursor:pointer; font-weight:bold">Nova Conversa +</button>
            <button id="btn-logout" style="margin-top: auto; padding: 12px; background: none; border: 1px solid #ff4444; color: #ff4444; border-radius: 10px; cursor: pointer;">Sair da Conta</button>
        </aside>

        <main id="main-content" style="flex:1; display:flex; flex-direction:column;">
            <div class="settings-btn" onclick="toggleThemeMenu()">
                <img src="Configroxa.png" id="configIcon" alt="Configurações">
            </div>

            <div id="theme-menu">
                <button class="t-btn" style="background:#6d28d9" onclick="setTheme('roxo')">Tema Roxo</button>
                <button class="t-btn" style="background:#888" onclick="setTheme('claro')">Tema Claro</button>
                <button class="t-btn" style="background:#1a1a1a" onclick="setTheme('escuro')">Tema Preto</button>
            </div>

            <div id="chatWindow">
                <div id="welcome" style="text-align:center; margin-top:15vh">
                    <img src="logoroxa.png" width="100" id="mainLogo">
                    <h2 id="welcomeText" style="margin-top:10px">Olá!</h2>
                </div>
            </div>

            <div class="footer-area">
                <div class="input-wrapper">
                    <input type="text" class="input-box" id="userInput" placeholder="Escreva uma mensagem..." autocomplete="off">
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getAuth, signInWithRedirect, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBnaeFZVMY7M2bG177YKB5yKqdH58YdBJo",
            authDomain: "escupt-ia.firebaseapp.com",
            projectId: "escupt-ia",
            storageBucket: "escupt-ia.firebasestorage.app",
            messagingSenderId: "972278178048",
            appId: "1:972278178048:web:86c0e2f204dbd873a453e5",
            measurementId: "G-4S14BCEV9S"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        window.loginComGoogle = () => signInWithRedirect(auth, provider);
        window.logout = () => signOut(auth).then(() => { localStorage.clear(); location.reload(); });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('login-screen').style.display = "none";
                document.getElementById('app-container').style.display = "flex";
                document.getElementById('userName').textContent = user.displayName;
                document.getElementById('userPhoto').src = user.photoURL;
                document.getElementById('userPhoto').style.display = "block";
                document.getElementById('welcomeText').textContent = `Olá, ${user.displayName.split(' ')[0]}!`;
                setTimeout(loadSavedChat, 100);
            }
        });

        document.getElementById('btn-login-google').onclick = window.loginComGoogle;
        document.getElementById('btn-logout').onclick = window.logout;
    </script>

    <script>
        const NGROK_URL = "https://chorographically-nonallegiance-rubye.ngrok-free.dev";
        const MODEL_NAME = "EscuptIA_Oficial";
        let chatHistory = [];

        function toggleSidebar() {
            const side = document.getElementById('sidebar');
            const over = document.getElementById('overlay');
            side.classList.toggle('active');
            over.style.display = side.classList.contains('active') ? 'block' : 'none';
        }

        function toggleThemeMenu() {
            const m = document.getElementById('theme-menu');
            m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
        }

        window.setTheme = (t) => {
            document.body.setAttribute('data-theme', t);
            const mainLogo = document.getElementById('mainLogo');
            const icon = document.getElementById('configIcon');
            if(t === 'roxo') { mainLogo.src = "logoroxa.png"; icon.src = "Configroxa.png"; }
            else if(t === 'claro') { mainLogo.src = "logobranca.png"; icon.src = "Configbranca.png"; }
            else { mainLogo.src = "logoescura.png"; icon.src = "Configescura.png"; }
            document.getElementById('theme-menu').style.display = "none";
        };

        function saveToStorage() {
            try { localStorage.setItem('escupt_history', JSON.stringify(chatHistory)); } catch (e) {}
        }

        function loadSavedChat() {
            const saved = localStorage.getItem('escupt_history');
            if (saved) {
                chatHistory = JSON.parse(saved);
                if (chatHistory.length > 0) {
                    document.getElementById('welcome').style.display = "none";
                    const chatWindow = document.getElementById('chatWindow');
                    chatHistory.forEach(msg => {
                        const d = document.createElement('div');
                        d.className = `message ${msg.role === 'user' ? 'user-message' : 'ai-message'}`;
                        d.innerHTML = marked.parse(msg.content);
                        chatWindow.appendChild(d);
                    });
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                }
            }
        }

        function clearChat() {
            localStorage.removeItem('escupt_history');
            chatHistory = [];
            location.reload();
        }

        async function sendMessage(text) {
            if(!text.trim()) return;
            document.getElementById('welcome').style.display = "none";
            addMsgToUI(text, 'user-message');
            chatHistory.push({ role: 'user', content: text });
            saveToStorage();

            const aiDiv = addMsgToUI("<i>Digitando...</i>", 'ai-message');

            try {
                const response = await fetch(`${NGROK_URL}/api/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: MODEL_NAME, prompt: text, stream: false })
                });
                const data = await response.json();
                aiDiv.innerHTML = "";
                typeWrite(aiDiv, data.response, () => {
                    chatHistory.push({ role: 'assistant', content: data.response });
                    saveToStorage();
                });
            } catch (err) { aiDiv.textContent = "Erro de conexão."; }
        }

        function typeWrite(element, text, onComplete) {
            let i = 0;
            function t() {
                if (i < text.length) {
                    element.innerHTML = marked.parse(text.substring(0, i + 1));
                    i++;
                    document.getElementById('chatWindow').scrollTop = 99999;
                    setTimeout(t, 5);
                } else if (onComplete) { onComplete(); }
            }
            t();
        }

        function addMsgToUI(text, cls) {
            const d = document.createElement('div');
            d.className = `message ${cls}`;
            d.innerHTML = marked.parse(text);
            const cw = document.getElementById('chatWindow');
            cw.appendChild(d);
            cw.scrollTop = cw.scrollHeight;
            return d;
        }

        document.getElementById('userInput').addEventListener('keypress', e => {
            if(e.key === 'Enter' && e.target.value) { sendMessage(e.target.value); e.target.value = ""; }
        });
    </script>
</body>
</html>
